name: Build LOS23 Kernel with Device Config + KernelSU

on:
  workflow_dispatch:

env:
  KERNEL_SOURCE: https://github.com/LineageOS/android_kernel_oneplus_sm8250.git
  KERNEL_BRANCH: lineage-23.0

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl wget bc bison build-essential flex \
            libssl-dev libelf-dev python3 cpio zip

      - name: Setup Clang
        run: |
          mkdir -p toolchains/clang
          curl -sL "https://github.com/ZyCromerZ/Clang/releases/download/14.0.6-20250704-release/Clang-14.0.6-20250704.tar.gz" | \
            tar -xzf - -C toolchains/clang
          echo "$GITHUB_WORKSPACE/toolchains/clang/bin" >> $GITHUB_PATH

      - name: Setup GCC
        run: |
          git clone --depth=1 -b android12L-release \
            https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 \
            toolchains/gcc64
          git clone --depth=1 -b android12L-release \
            https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9 \
            toolchains/gcc32
          echo "$GITHUB_WORKSPACE/toolchains/gcc64/bin" >> $GITHUB_PATH
          echo "$GITHUB_WORKSPACE/toolchains/gcc32/bin" >> $GITHUB_PATH

      - name: Clone Kernel
        run: |
          git clone --depth=1 -b $KERNEL_BRANCH $KERNEL_SOURCE kernel

      - name: Fix LineageOS 23 Bugs
        run: |
          cd kernel

          # Fix qpnp-power-on.c - comment out log_kpd_event references (struct member missing in LOS23)
          sed -i 's/if (pon->log_kpd_event && (cfg->pon_type == PON_KPDPWR))/if (0)/' drivers/input/misc/qpnp-power-on.c
          sed -i 's/if (pon->log_kpd_event) {/if (0) {/' drivers/input/misc/qpnp-power-on.c

          # Remove multi-line log_kpd_event assignment (spans 2 lines)
          sed -i '/pon->log_kpd_event = of_property_read_bool/,/"qcom,log-kpd-event");/d' drivers/input/misc/qpnp-power-on.c

          # Fix schgm-flash.h - add forward declaration for smb_charger struct at beginning
          sed -i '1i struct smb_charger;' drivers/power/supply/qcom/schgm-flash.h || true
          # Add smb5-lib.h include to schgm-flash.c
          sed -i '/#include "schgm-flash.h"/a #include "smb5-lib.h"' drivers/power/supply/qcom/schgm-flash.c || true

          # Fix ion_system_heap.c - NR_IONCACHE_PAGES undefined - comment out these checks
          sed -i 's/global_zone_page_state(NR_IONCACHE_PAGES)/0/g' drivers/staging/android/ion/ion_system_heap.c || true

          # NOTE: Device config enables actual OPLUS drivers, so we don't need stubs
          # (Stubs are only needed for defconfig builds which lack OPLUS drivers)

      - name: Backport path_umount and get_cred_rcu (required for older kernels)
        run: |
          cd kernel
          # path_umount was added in Linux 5.9, need to backport for 4.19
          # Add the function to fs/namespace.c (include version.h for KERNEL_VERSION macro)
          cat >> fs/namespace.c << 'EOFPATCH'

          /* Backport path_umount from Linux 5.9+ for KernelSU */
          #include <linux/version.h>
          #if LINUX_VERSION_CODE < KERNEL_VERSION(5, 9, 0)
          int path_umount(struct path *path, int flags)
          {
              /* do_umount expects struct mount*, not struct vfsmount* */
              /* Use real_mount() macro to convert vfsmount to mount */
              struct mount *mnt = real_mount(path->mnt);
              return do_umount(mnt, flags);
          }
          EXPORT_SYMBOL(path_umount);
          #endif
          EOFPATCH

          # Add declaration to include/linux/mount.h
          sed -i '/^extern void mnt_set_expiry/i extern int path_umount(struct path *path, int flags);' include/linux/mount.h

          # Backport get_cred_rcu for kernels that don't have it
          # First check if it already exists in the kernel
          if ! grep -q "get_cred_rcu" include/linux/cred.h; then
            echo "Adding get_cred_rcu backport..."
            # Insert BEFORE the final #endif of the include guard
            sed -i '/#endif.*_LINUX_CRED_H/i \
          /* Backport get_cred_rcu for KernelSU */ \
          static inline const struct cred *get_cred_rcu(const struct cred *cred) \
          { \
              struct cred *nonconst_cred = (struct cred *) cred; \
              if (!cred) \
                  return NULL; \
              if (!atomic_inc_not_zero(\&nonconst_cred->usage)) \
                  return NULL; \
              return cred; \
          }
          ' include/linux/cred.h
          else
            echo "get_cred_rcu already exists in kernel, skipping backport"
          fi

      - name: Setup KernelSU (mlm-games non-GKI fork)
        run: |
          cd kernel
          # Use mlm-games KernelSU-Non-GKI fork - has proper kernel version guards
          # and doesn't have pkg_observer.c (avoids fsnotify API issues on 4.19)
          # Manual setup instead of their setup.sh (which has sh/bash compatibility issues)

          # Clone the repository at latest stable tag
          git clone --depth=1 -b v1.0.2 https://github.com/mlm-games/KernelSU-Non-GKI KernelSU

          # Create symlink in drivers
          ln -sf ../KernelSU/kernel drivers/kernelsu

          # Add to Makefile
          echo 'obj-$(CONFIG_KSU) += kernelsu/' >> drivers/Makefile

          # Add to Kconfig (before endmenu)
          sed -i '/^endmenu/i source "drivers/kernelsu/Kconfig"' drivers/Kconfig

          # Tell KernelSU that path_umount is available (we backported it)
          echo "ccflags-y += -DKSU_UMOUNT" >> drivers/kernelsu/Makefile

      - name: Use Device Config
        run: |
          cd kernel
          mkdir -p out
          cp $GITHUB_WORKSPACE/device_config out/.config
          make O=out ARCH=arm64 olddefconfig

      - name: Enable KSU in Config
        run: |
          cd kernel
          scripts/config --file out/.config -e KSU
          make O=out ARCH=arm64 olddefconfig

      - name: Build Kernel
        run: |
          cd kernel
          make -j$(nproc --all) O=out ARCH=arm64 CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-android- \
            CROSS_COMPILE_ARM32=arm-linux-androideabi- \
            LLVM_IAS=1 LD=ld.lld AR=llvm-ar NM=llvm-nm \
            OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip

      - name: Package
        run: |
          cd kernel
          if [ ! -f "out/arch/arm64/boot/Image" ]; then
            echo "Build failed!"
            exit 1
          fi

          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git
          cd AnyKernel3
          rm -rf .git modules patch ramdisk
          cp ../out/arch/arm64/boot/Image .
          sed -i 's/do.devicecheck=.*/do.devicecheck=1/g' anykernel.sh
          sed -i 's/device.name1=.*/device.name1=instantnoodlep/g' anykernel.sh
          sed -i 's|block=.*|block=/dev/block/bootdevice/by-name/boot;|g' anykernel.sh
          sed -i 's/is_slot_device=.*/is_slot_device=1;/g' anykernel.sh

          ZIP_NAME="KernelSU_DeviceConfig_OnePlus8Pro_$(date +%Y%m%d).zip"
          zip -r9 "$GITHUB_WORKSPACE/$ZIP_NAME" * -x .git README.md *placeholder
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: device-config-${{ github.run_number }}
          name: KernelSU Device Config Build ${{ github.run_number }}
          files: ${{ env.ZIP_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
