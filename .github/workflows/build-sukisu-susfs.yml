name: Build LOS23 Kernel with KernelSU-Next + SUSFS 1.5.9 (Non-GKI)

on:
  workflow_dispatch:

env:
  KERNEL_SOURCE: https://github.com/LineageOS/android_kernel_oneplus_sm8250.git
  KERNEL_BRANCH: lineage-23.0
  # Use gordboy's kernel as reference for SUSFS integration
  SUSFS_KERNEL: https://github.com/gordboy/android_kernel_oneplus_sm8250_los_22.2_gordboy.git
  SUSFS_BRANCH: Working

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl wget bc bison build-essential flex \
            libssl-dev libelf-dev python3 cpio zip android-sdk-libsparse-utils lz4

      - name: Setup mkbootimg tools
        run: |
          git clone --depth=1 https://android.googlesource.com/platform/system/tools/mkbootimg
          chmod +x mkbootimg/*.py
          echo "$GITHUB_WORKSPACE/mkbootimg" >> $GITHUB_PATH

      - name: Setup Clang
        run: |
          mkdir -p toolchains/clang
          curl -sL "https://github.com/ZyCromerZ/Clang/releases/download/14.0.6-20250704-release/Clang-14.0.6-20250704.tar.gz" | \
            tar -xzf - -C toolchains/clang
          echo "$GITHUB_WORKSPACE/toolchains/clang/bin" >> $GITHUB_PATH

      - name: Setup GCC
        run: |
          git clone --depth=1 -b android12L-release \
            https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 \
            toolchains/gcc64
          git clone --depth=1 -b android12L-release \
            https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9 \
            toolchains/gcc32
          echo "$GITHUB_WORKSPACE/toolchains/gcc64/bin" >> $GITHUB_PATH
          echo "$GITHUB_WORKSPACE/toolchains/gcc32/bin" >> $GITHUB_PATH

      - name: Clone Kernel
        run: |
          git clone --depth=1 -b $KERNEL_BRANCH $KERNEL_SOURCE kernel

      - name: Fix LineageOS 23 Bugs
        run: |
          cd kernel

          # Fix qpnp-power-on.c - comment out log_kpd_event references (struct member missing in LOS23)
          sed -i 's/if (pon->log_kpd_event && (cfg->pon_type == PON_KPDPWR))/if (0)/' drivers/input/misc/qpnp-power-on.c
          sed -i 's/if (pon->log_kpd_event) {/if (0) {/' drivers/input/misc/qpnp-power-on.c

          # Remove multi-line log_kpd_event assignment (spans 2 lines)
          sed -i '/pon->log_kpd_event = of_property_read_bool/,/"qcom,log-kpd-event");/d' drivers/input/misc/qpnp-power-on.c

          # Fix schgm-flash.h - add forward declaration for smb_charger struct at beginning
          sed -i '1i struct smb_charger;' drivers/power/supply/qcom/schgm-flash.h || true
          # Add smb5-lib.h include to schgm-flash.c
          sed -i '/#include "schgm-flash.h"/a #include "smb5-lib.h"' drivers/power/supply/qcom/schgm-flash.c || true

          # Fix ion_system_heap.c - NR_IONCACHE_PAGES undefined - comment out these checks
          sed -i 's/global_zone_page_state(NR_IONCACHE_PAGES)/0/g' drivers/staging/android/ion/ion_system_heap.c || true

      - name: Backport path_umount and get_cred_rcu (required for older kernels)
        run: |
          cd kernel
          # path_umount was added in Linux 5.9, need to backport for 4.19
          echo "Adding path_umount backport..."
          cat >> fs/namespace.c << 'EOFPATCH'

          /* Backport path_umount from Linux 5.9+ for KernelSU */
          #include <linux/version.h>
          #if LINUX_VERSION_CODE < KERNEL_VERSION(5, 9, 0)
          int path_umount(struct path *path, int flags)
          {
              struct mount *mnt = real_mount(path->mnt);
              return do_umount(mnt, flags);
          }
          EXPORT_SYMBOL(path_umount);
          #endif
          EOFPATCH
          sed -i '/^extern void mnt_set_expiry/i extern int path_umount(struct path *path, int flags);' include/linux/mount.h

          # Backport get_cred_rcu for kernels that don't have it
          if ! grep -q "get_cred_rcu" include/linux/cred.h; then
            echo "Adding get_cred_rcu backport..."
            sed -i '/#endif.*_LINUX_CRED_H/i \
          /* Backport get_cred_rcu for KernelSU */ \
          static inline const struct cred *get_cred_rcu(const struct cred *cred) \
          { \
              struct cred *nonconst_cred = (struct cred *) cred; \
              if (!cred) \
                  return NULL; \
              if (!atomic_inc_not_zero(\&nonconst_cred->usage)) \
                  return NULL; \
              return cred; \
          }
          ' include/linux/cred.h
          else
            echo "get_cred_rcu already exists in kernel, skipping backport"
          fi

      - name: Patch Kernel Structures for SUSFS (gordboy approach)
        run: |
          cd kernel
          echo "=== Patching kernel structures for SUSFS 1.5.x (gordboy approach) ==="

          # CRITICAL: SUSFS requires susfs_task_state field in task_struct
          # gordboy's kernel uses ANDROID_KABI_USE macros to add these fields
          # LineageOS kernel has ANDROID_KABI_RESERVE macros we can convert

          echo "Checking for ANDROID_KABI in sched.h..."
          grep -n "ANDROID_KABI" include/linux/sched.h | head -20 || echo "No ANDROID_KABI found"

          # Add susfs_task_state and susfs_last_fake_mnt_id to task_struct
          echo "Adding SUSFS fields to task_struct..."

          # gordboy uses: ANDROID_KABI_USE(6, u64 susfs_task_state);
          #               ANDROID_KABI_USE(8, u64 susfs_last_fake_mnt_id);

          if grep -q "ANDROID_KABI_RESERVE" include/linux/sched.h; then
            echo "Found ANDROID_KABI_RESERVE entries, adding SUSFS fields..."

            # Create a patch file for sched.h modifications
            cat > /tmp/susfs_sched_patch.txt << 'PATCHEOF'
          #ifdef CONFIG_KSU_SUSFS
          #include <linux/susfs_def.h>
          #endif
          PATCHEOF

            # Add susfs_def.h include after android_kabi.h
            sed -i '/#include <linux\/android_kabi.h>/r /tmp/susfs_sched_patch.txt' include/linux/sched.h

            # Replace ANDROID_KABI_RESERVE(6) with conditional SUSFS use
            # Using printf to handle the newlines properly
            REPLACE6=$(printf '#ifdef CONFIG_KSU_SUSFS\n\tANDROID_KABI_USE(6, u64 susfs_task_state);\n#else\n\tANDROID_KABI_RESERVE(6);\n#endif')
            sed -i "s/ANDROID_KABI_RESERVE(6);/${REPLACE6}/g" include/linux/sched.h

            # Replace ANDROID_KABI_RESERVE(8) with conditional SUSFS use
            REPLACE8=$(printf '#ifdef CONFIG_KSU_SUSFS\n\tANDROID_KABI_USE(8, u64 susfs_last_fake_mnt_id);\n#else\n\tANDROID_KABI_RESERVE(8);\n#endif')
            sed -i "s/ANDROID_KABI_RESERVE(8);/${REPLACE8}/g" include/linux/sched.h

            echo "=== Checking sched.h modifications ==="
            grep -n "susfs\|SUSFS\|KABI_USE" include/linux/sched.h | head -20
          else
            echo "No ANDROID_KABI_RESERVE found, adding SUSFS fields directly..."
            # For kernels without KABI reserves, add fields directly before randomized_struct_fields_end
            cat > /tmp/susfs_fields.txt << 'FIELDSEOF'
          #ifdef CONFIG_KSU_SUSFS
          	u64 susfs_task_state;
          	u64 susfs_last_fake_mnt_id;
          #endif
          FIELDSEOF
            sed -i '/randomized_struct_fields_end/r /tmp/susfs_fields.txt' include/linux/sched.h
          fi

          echo "Checking user_struct for ANDROID_KABI..."
          grep -q "ANDROID_KABI_RESERVE" include/linux/sched/user.h 2>/dev/null && echo "Found KABI in user.h" || echo "No KABI in user.h"

      - name: Integrate SUSFS 1.5.9 from gordboy
        run: |
          cd kernel
          echo "Integrating SUSFS 1.5.9 from gordboy's kernel..."

          # Clone gordboy's kernel to get SUSFS files
          git clone --depth=1 -b $SUSFS_BRANCH $SUSFS_KERNEL ../gordboy-kernel

          # Copy SUSFS source files from gordboy's kernel
          echo "Copying SUSFS 1.5.9 source files..."
          cp ../gordboy-kernel/fs/susfs.c fs/susfs.c
          cp ../gordboy-kernel/include/linux/susfs.h include/linux/susfs.h

          # susfs_def.h should already be added via sched.h patch, but ensure it exists
          if [ -f "../gordboy-kernel/include/linux/susfs_def.h" ]; then
            cp ../gordboy-kernel/include/linux/susfs_def.h include/linux/susfs_def.h
          fi

          echo "=== SUSFS Version ==="
          grep "SUSFS_VERSION" include/linux/susfs.h || echo "Version not found"

          # Add SUSFS to fs/Makefile
          if ! grep -q "susfs.o" fs/Makefile; then
            echo 'obj-$(CONFIG_KSU_SUSFS) += susfs.o' >> fs/Makefile
            echo "Added susfs.o to fs/Makefile"
          fi

          # Apply kernel hooks for SUSFS from gordboy's patches
          echo "=== Applying SUSFS kernel hooks from gordboy ==="

          # Check what hooks gordboy has applied
          echo "Checking gordboy's kernel patches..."

          # Copy hook patches from gordboy if they exist as diff files
          # Otherwise we need to apply them manually

          # Add susfs.h include to necessary files (based on gordboy's changes)
          for file in fs/namei.c fs/open.c fs/read_write.c fs/stat.c fs/readdir.c fs/proc/task_mmu.c fs/namespace.c; do
            if [ -f "$file" ] && ! grep -q "linux/susfs.h" "$file"; then
              sed -i '/#include <linux\/fs.h>/a #include <linux/susfs.h>' "$file" 2>/dev/null || \
              sed -i '1a #include <linux/susfs.h>' "$file"
              echo "Added susfs.h include to $file"
            fi
          done

          echo "=== Verifying SUSFS integration ==="
          ls -la fs/susfs.c include/linux/susfs.h include/linux/susfs_def.h 2>/dev/null || echo "Some SUSFS files missing"

          # Cleanup
          rm -rf ../gordboy-kernel

      - name: Setup KernelSU-Next with SUSFS support (gordboy approach)
        run: |
          cd kernel
          echo "Setting up KernelSU-Next with SUSFS support (like gordboy)..."

          # gordboy uses KernelSU-Next which has SUSFS support built-in
          # Use rsuntk's fork which supports non-GKI 4.19 kernels
          curl -LSs "https://raw.githubusercontent.com/rsuntk/KernelSU/main/kernel/setup.sh" | bash -s main

          # Tell KernelSU that path_umount is available (we backported it)
          echo "ccflags-y += -DKSU_UMOUNT" >> drivers/kernelsu/Makefile

          # Add SUSFS Kconfig options if not present (required for SUSFS 1.5.x)
          if ! grep -q "KSU_SUSFS" drivers/kernelsu/Kconfig; then
            echo "Adding SUSFS Kconfig options..."
            cat >> drivers/kernelsu/Kconfig << 'KSUCONFIGEOF'

          config KSU_SUSFS
          	bool "Enable SUSFS for KernelSU"
          	depends on KSU
          	default y
          	help
          	  Enable SUSFS (Stealth User Space File System) support for KernelSU.
          	  This provides advanced hiding capabilities.

          config KSU_SUSFS_HAS_MAGIC_MOUNT
          	bool "SUSFS has magic mount"
          	depends on KSU_SUSFS
          	default y

          config KSU_SUSFS_SUS_PATH
          	bool "Enable sus_path"
          	depends on KSU_SUSFS
          	default y

          config KSU_SUSFS_SUS_MOUNT
          	bool "Enable sus_mount"
          	depends on KSU_SUSFS
          	default y

          config KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT
          	bool "Auto add sus KSU default mount"
          	depends on KSU_SUSFS
          	default y

          config KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT
          	bool "Auto add sus bind mount"
          	depends on KSU_SUSFS
          	default y

          config KSU_SUSFS_SUS_KSTAT
          	bool "Enable sus_kstat"
          	depends on KSU_SUSFS
          	default y

          config KSU_SUSFS_SUS_OVERLAYFS
          	bool "Enable sus_overlayfs"
          	depends on KSU_SUSFS
          	default y

          config KSU_SUSFS_TRY_UMOUNT
          	bool "Enable try_umount"
          	depends on KSU_SUSFS
          	default y

          config KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT
          	bool "Auto add try_umount for bind mount"
          	depends on KSU_SUSFS
          	default y

          config KSU_SUSFS_SPOOF_UNAME
          	bool "Enable spoof_uname"
          	depends on KSU_SUSFS
          	default y

          config KSU_SUSFS_ENABLE_LOG
          	bool "Enable SUSFS logging"
          	depends on KSU_SUSFS
          	default y

          config KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS
          	bool "Hide KSU SUSFS symbols"
          	depends on KSU_SUSFS
          	default y

          config KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG
          	bool "Spoof cmdline or bootconfig"
          	depends on KSU_SUSFS
          	default y

          config KSU_SUSFS_OPEN_REDIRECT
          	bool "Enable open_redirect"
          	depends on KSU_SUSFS
          	default y

          config KSU_SUSFS_SUS_SU
          	bool "Enable sus_su"
          	depends on KSU_SUSFS
          	default y
          KSUCONFIGEOF
          fi

          # Fix MODULE_IMPORT_NS for kernel 4.19 (this macro was added in kernel 5.4)
          echo "Fixing MODULE_IMPORT_NS for kernel 4.19..."
          for f in drivers/kernelsu/*.c; do
            if grep -q "MODULE_IMPORT_NS" "$f"; then
              sed -i '/MODULE_IMPORT_NS/d' "$f"
              echo "Removed MODULE_IMPORT_NS from $f"
            fi
          done

          # Fix TWA_RESUME for kernel 4.19 (task_work API changed in 5.x)
          echo "Fixing task_work API for kernel 4.19..."
          for f in drivers/kernelsu/*.c; do
            if grep -q "TWA_RESUME" "$f"; then
              sed -i 's/TWA_RESUME/true/g' "$f"
              echo "Fixed TWA_RESUME in $f"
            fi
          done

          # Add missing includes for kernel 4.19
          echo "Adding missing includes for kernel 4.19..."
          for f in drivers/kernelsu/*.c; do
            if grep -q "#include <linux/sched.h>" "$f" && ! grep -q "linux/sched/task.h" "$f"; then
              sed -i '/#include <linux\/sched.h>/a #include <linux/sched/task.h>' "$f"
              echo "Added sched/task.h include to $f"
            fi
          done

          echo "=== KernelSU-Next Version ==="
          cat drivers/kernelsu/Makefile | head -20
          echo "=== Checking Kconfig for SUSFS options ==="
          grep -E "SUSFS" drivers/kernelsu/Kconfig | head -20 || echo "No SUSFS in Kconfig"

      - name: Check KernelSU + SUSFS Integration
        run: |
          cd kernel
          echo "KernelSU-Next + SUSFS integrated via drivers/kernelsu"
          ls -la drivers/kernelsu/
          echo "=== KernelSU source files ==="
          find drivers/kernelsu -name "*.c" -o -name "*.h" | head -30
          echo "=== Checking for SUSFS in Kconfig ==="
          grep -E "SUSFS|susfs" drivers/kernelsu/Kconfig | head -30 || echo "No SUSFS in Kconfig"

      - name: Use Device Config
        run: |
          cd kernel
          mkdir -p out
          cp $GITHUB_WORKSPACE/device_config out/.config
          make O=out ARCH=arm64 olddefconfig

      - name: Enable KSU and SUSFS in Config
        run: |
          cd kernel
          # Enable KernelSU
          scripts/config --file out/.config -e KSU

          # Enable kallsyms for proper symbol resolution (required for non-GKI hooks)
          scripts/config --file out/.config -e KALLSYMS
          scripts/config --file out/.config -e KALLSYMS_ALL

          # Enable SUSFS 1.5.x features
          echo "Enabling SUSFS v1.5.x features..."
          scripts/config --file out/.config -e KSU_SUSFS
          scripts/config --file out/.config -e KSU_SUSFS_HAS_MAGIC_MOUNT
          scripts/config --file out/.config -e KSU_SUSFS_SUS_PATH
          scripts/config --file out/.config -e KSU_SUSFS_SUS_MOUNT
          scripts/config --file out/.config -e KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT
          scripts/config --file out/.config -e KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT
          scripts/config --file out/.config -e KSU_SUSFS_SUS_KSTAT
          scripts/config --file out/.config -e KSU_SUSFS_SUS_OVERLAYFS
          scripts/config --file out/.config -e KSU_SUSFS_TRY_UMOUNT
          scripts/config --file out/.config -e KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT
          scripts/config --file out/.config -e KSU_SUSFS_SPOOF_UNAME
          scripts/config --file out/.config -e KSU_SUSFS_ENABLE_LOG
          scripts/config --file out/.config -e KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS
          scripts/config --file out/.config -e KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG
          scripts/config --file out/.config -e KSU_SUSFS_OPEN_REDIRECT
          scripts/config --file out/.config -e KSU_SUSFS_SUS_SU

          make O=out ARCH=arm64 olddefconfig

          # Show what SUSFS options are available and enabled
          echo "=== Available SUSFS Kconfig options ==="
          cat drivers/kernelsu/Kconfig 2>/dev/null | grep -E "config KSU|SUSFS" || echo "No SUSFS in Kconfig"
          echo "=== Enabled SUSFS config ==="
          grep -E "CONFIG_KSU|SUSFS" out/.config | head -40 || echo "No SUSFS configs found"

      - name: Build Kernel
        run: |
          cd kernel
          make -j$(nproc --all) O=out ARCH=arm64 CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-android- \
            CROSS_COMPILE_ARM32=arm-linux-androideabi- \
            LLVM_IAS=1 LD=ld.lld AR=llvm-ar NM=llvm-nm \
            OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip

      - name: Package
        run: |
          cd kernel
          if [ ! -f "out/arch/arm64/boot/Image" ]; then
            echo "Build failed!"
            exit 1
          fi

          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git
          cd AnyKernel3
          rm -rf .git modules patch ramdisk
          cp ../out/arch/arm64/boot/Image .
          sed -i 's/do.devicecheck=.*/do.devicecheck=1/g' anykernel.sh
          sed -i 's/device.name1=.*/device.name1=instantnoodlep/g' anykernel.sh
          sed -i 's|block=.*|block=/dev/block/bootdevice/by-name/boot;|g' anykernel.sh
          sed -i 's/is_slot_device=.*/is_slot_device=1;/g' anykernel.sh

          ZIP_NAME="KernelSU-SUSFS_OnePlus8Pro_$(date +%Y%m%d).zip"
          zip -r9 "$GITHUB_WORKSPACE/$ZIP_NAME" * -x .git README.md *placeholder
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Create boot.img
        run: |
          cd kernel
          BOOT_IMG="KernelSU-SUSFS_boot_OnePlus8Pro_$(date +%Y%m%d).img"

          # Use pre-extracted ramdisk and dtb from repo
          lz4 -l -12 --favor-decSpeed "$GITHUB_WORKSPACE/lineage-os/ramdisk.cpio" ramdisk.cpio.lz4

          python3 $GITHUB_WORKSPACE/mkbootimg/mkbootimg.py \
            --kernel out/arch/arm64/boot/Image \
            --ramdisk ramdisk.cpio.lz4 \
            --dtb "$GITHUB_WORKSPACE/lineage-os/dtb" \
            --pagesize 4096 \
            --base 0x00000000 \
            --kernel_offset 0x00008000 \
            --ramdisk_offset 0x01000000 \
            --tags_offset 0x00000100 \
            --dtb_offset 0x01f00000 \
            --header_version 2 \
            --os_version 16.0.0 \
            --os_patch_level 2025-12 \
            --cmdline "androidboot.hardware=qcom androidboot.memcg=1 androidboot.usbcontroller=a600000.dwc3 cgroup.memory=nokmem,nosocket loop.max_part=7 lpm_levels.sleep_disabled=1 msm_rtb.filter=0x237 reboot=panic_warm service_locator.enable=1 swiotlb=2048" \
            --output "$GITHUB_WORKSPACE/$BOOT_IMG"

          echo "Created boot.img with LineageOS ramdisk and dtb"
          echo "BOOT_IMG=$BOOT_IMG" >> $GITHUB_ENV
          ls -lh "$GITHUB_WORKSPACE/$BOOT_IMG"

      - name: Upload AnyKernel3 ZIP
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}

      - name: Upload boot.img
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BOOT_IMG }}
          path: ${{ env.BOOT_IMG }}

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: kernelsu-susfs-${{ github.run_number }}
          name: KernelSU + SUSFS 1.5.9 Build ${{ github.run_number }}
          body: |
            ## KernelSU + SUSFS 1.5.9 for OnePlus 8 Pro (LineageOS 23)

            This build uses [gordboy's approach](https://github.com/gordboy/android_kernel_oneplus_sm8250_los_22.2_gordboy) for SUSFS integration:
            - SUSFS 1.5.9 integrated directly into kernel with proper structure patches
            - Uses ANDROID_KABI_USE macros to add susfs_task_state to task_struct
            - rsuntk's KernelSU fork for non-GKI 4.19 kernel support
            - Full SUSFS 1.5.x feature set

            ### SUSFS Module Compatibility
            **This kernel uses SUSFS v1.5.9**
            - Use SUSFS module v1.5.x from: https://github.com/sidex15/susfs4ksu-module/releases
            - Compatible with latest SUSFS features

            ### Features
            - KernelSU root management
            - SUSFS 1.5.9 integration:
              - SUS_PATH: Hide paths from detection
              - SUS_MOUNT: Hide mount points
              - SUS_KSTAT: Spoof file stats
              - SPOOF_UNAME: Spoof kernel version
              - OPEN_REDIRECT: Redirect file opens
              - SUS_SU: Runtime su control
              - SUS_OVERLAYFS: Hide overlay mounts
              - And more...

            ### Installation
            - Flash `KernelSU-SUSFS_OnePlus8Pro_*.zip` via TWRP/custom recovery
            - Or fastboot flash the `boot.img` directly

            ### Manager
            Use KernelSU Manager from: https://github.com/tiann/KernelSU/releases
          files: |
            ${{ env.ZIP_NAME }}
            ${{ env.BOOT_IMG }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
