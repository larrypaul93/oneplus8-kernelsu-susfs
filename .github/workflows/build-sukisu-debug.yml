name: Build SukiSU-Ultra Debug (No SUSFS)

on:
  workflow_dispatch:
    # Debug build - Base SukiSU without SUSFS to confirm base works

env:
  KERNEL_SOURCE: https://github.com/LineageOS/android_kernel_oneplus_sm8250.git
  KERNEL_BRANCH: lineage-23.0
  DEFCONFIG: vendor/kona-perf_defconfig

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl wget bc bison build-essential flex \
            libssl-dev libelf-dev python3 cpio zip android-sdk-libsparse-utils lz4

      - name: Setup mkbootimg tools
        run: |
          git clone --depth=1 https://android.googlesource.com/platform/system/tools/mkbootimg
          chmod +x mkbootimg/*.py
          echo "$GITHUB_WORKSPACE/mkbootimg" >> $GITHUB_PATH

      - name: Cache Clang Toolchain
        id: cache-clang
        uses: actions/cache@v4
        with:
          path: toolchains/clang
          key: clang-14.0.6-20250704

      - name: Setup Clang
        if: steps.cache-clang.outputs.cache-hit != 'true'
        run: |
          mkdir -p toolchains/clang
          curl -sL "https://github.com/ZyCromerZ/Clang/releases/download/14.0.6-20250704-release/Clang-14.0.6-20250704.tar.gz" | \
            tar -xzf - -C toolchains/clang

      - name: Add Clang to PATH
        run: echo "$GITHUB_WORKSPACE/toolchains/clang/bin" >> $GITHUB_PATH

      - name: Cache GCC Toolchains
        id: cache-gcc
        uses: actions/cache@v4
        with:
          path: |
            toolchains/gcc64
            toolchains/gcc32
          key: gcc-android12L-aarch64-arm

      - name: Setup GCC
        if: steps.cache-gcc.outputs.cache-hit != 'true'
        run: |
          git clone --depth=1 -b android12L-release \
            https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 \
            toolchains/gcc64
          git clone --depth=1 -b android12L-release \
            https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9 \
            toolchains/gcc32

      - name: Add GCC to PATH
        run: |
          echo "$GITHUB_WORKSPACE/toolchains/gcc64/bin" >> $GITHUB_PATH
          echo "$GITHUB_WORKSPACE/toolchains/gcc32/bin" >> $GITHUB_PATH

      - name: Clone Kernel
        run: |
          git clone --depth=1 -b $KERNEL_BRANCH $KERNEL_SOURCE kernel

      - name: Fix LineageOS 23 Bugs
        run: |
          cd kernel

          # Fix qpnp-power-on.c
          sed -i 's/if (pon->log_kpd_event && (cfg->pon_type == PON_KPDPWR))/if (0)/' drivers/input/misc/qpnp-power-on.c
          sed -i 's/if (pon->log_kpd_event) {/if (0) {/' drivers/input/misc/qpnp-power-on.c
          sed -i '/pon->log_kpd_event = of_property_read_bool/,/"qcom,log-kpd-event");/d' drivers/input/misc/qpnp-power-on.c

          # Fix get_cached_platform_id
          for f in $(grep -rl "get_cached_platform_id" --include="*.c" .); do
            sed -i '1i #ifndef get_cached_platform_id\n#define get_cached_platform_id() 0\n#endif' "$f"
          done

          # Fix schgm-flash.h
          sed -i '1i struct smb_charger;' drivers/power/supply/qcom/schgm-flash.h || true
          sed -i '/#include "schgm-flash.h"/a #include "smb5-lib.h"' drivers/power/supply/qcom/schgm-flash.c || true

          # Fix ion_system_heap.c
          sed -i 's/global_zone_page_state(NR_IONCACHE_PAGES)/0/g' drivers/staging/android/ion/ion_system_heap.c || true

          # Create stub file for missing OnePlus functions
          cat > drivers/soc/oplus/oplus_stubs.c << 'EOFSTUB'
          // Stubs for missing OnePlus functions
          #include <linux/module.h>
          void hans_report(int a, int b, int c, char* d) {}
          EXPORT_SYMBOL(hans_report);
          int get_boot_mode(void) { return 0; }
          EXPORT_SYMBOL(get_boot_mode);
          int get_eng_version(void) { return 0; }
          EXPORT_SYMBOL(get_eng_version);
          int oplus_daily_build(void) { return 0; }
          EXPORT_SYMBOL(oplus_daily_build);
          int kswapd_threads = 1;
          EXPORT_SYMBOL(kswapd_threads);
          int oplus_vooc_adapter_update_is_rx_gpio(void) { return 0; }
          EXPORT_SYMBOL(oplus_vooc_adapter_update_is_rx_gpio);
          int oplus_vooc_adapter_update_is_tx_gpio(void) { return 0; }
          EXPORT_SYMBOL(oplus_vooc_adapter_update_is_tx_gpio);
          int get_project(void) { return 0; }
          EXPORT_SYMBOL(get_project);
          int is_confidential(void) { return 0; }
          EXPORT_SYMBOL(is_confidential);
          void oplus_wpc_set_wrx_en_value(int a) {}
          EXPORT_SYMBOL(oplus_wpc_set_wrx_en_value);
          void opchg_set_pd_sdp(int a) {}
          EXPORT_SYMBOL(opchg_set_pd_sdp);
          void black_screen_timer_restart(void) {}
          EXPORT_SYMBOL(black_screen_timer_restart);
          void bright_screen_timer_restart(void) {}
          EXPORT_SYMBOL(bright_screen_timer_restart);
          int oplus_vooc_get_fastchg_started(void) { return 0; }
          EXPORT_SYMBOL(oplus_vooc_get_fastchg_started);
          int oplus_vooc_get_fastchg_ing(void) { return 0; }
          EXPORT_SYMBOL(oplus_vooc_get_fastchg_ing);
          int oplus_gauge_init(void *a) { return 0; }
          EXPORT_SYMBOL(oplus_gauge_init);
          int get_PCB_Version(void) { return 0; }
          EXPORT_SYMBOL(get_PCB_Version);
          void switch_headset_state(int a) {}
          EXPORT_SYMBOL(switch_headset_state);
          int opticalfp_irq_handler_register(void *a) { return 0; }
          EXPORT_SYMBOL(opticalfp_irq_handler_register);
          int is_project(int a) { return 0; }
          EXPORT_SYMBOL(is_project);
          int smblib_write(void *chg, int reg, int val) { return 0; }
          EXPORT_SYMBOL(smblib_write);
          int smblib_read(void *chg, int reg, int *val) { return 0; }
          EXPORT_SYMBOL(smblib_read);
          int smblib_masked_write(void *chg, int reg, int mask, int val) { return 0; }
          EXPORT_SYMBOL(smblib_masked_write);
          int qpnp_is_power_off_charging(void) { return 0; }
          EXPORT_SYMBOL(qpnp_is_power_off_charging);
          EOFSTUB
          echo 'obj-y += oplus_stubs.o' >> drivers/soc/oplus/Makefile

      - name: Setup SukiSU-Ultra (builtin only - NO SUSFS)
        run: |
          cd kernel
          # Use builtin method like Build 20 - NO SUSFS
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s builtin

      - name: Build Kernel
        run: |
          cd kernel

          make O=out ARCH=arm64 CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-android- \
            CROSS_COMPILE_ARM32=arm-linux-androideabi- \
            $DEFCONFIG

          # Enable KSU only - NO SUSFS
          scripts/config --file out/.config -e KSU

          make O=out ARCH=arm64 olddefconfig

          echo "Config check (no SUSFS expected):"
          grep -E "CONFIG_KSU" out/.config | head -10

          make -j$(nproc --all) O=out ARCH=arm64 CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-android- \
            CROSS_COMPILE_ARM32=arm-linux-androideabi- \
            LLVM_IAS=1 LD=ld.lld AR=llvm-ar NM=llvm-nm \
            OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip

      - name: Package
        run: |
          cd kernel
          if [ ! -f "out/arch/arm64/boot/Image" ]; then
            echo "Build failed!"
            exit 1
          fi

          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git
          cd AnyKernel3
          rm -rf .git modules patch ramdisk
          cp ../out/arch/arm64/boot/Image .
          sed -i 's/do.devicecheck=.*/do.devicecheck=1/g' anykernel.sh
          sed -i 's/device.name1=.*/device.name1=instantnoodlep/g' anykernel.sh
          sed -i 's|block=.*|block=/dev/block/bootdevice/by-name/boot;|g' anykernel.sh
          sed -i 's/is_slot_device=.*/is_slot_device=1;/g' anykernel.sh

          ZIP_NAME="SukiSU-Debug-NoSUSFS_OnePlus8Pro_$(date +%Y%m%d).zip"
          zip -r9 "$GITHUB_WORKSPACE/$ZIP_NAME" * -x .git README.md *placeholder
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Create boot.img
        run: |
          cd kernel
          BOOT_IMG="SukiSU-Debug-NoSUSFS_boot_OnePlus8Pro_$(date +%Y%m%d).img"
          lz4 -l -12 --favor-decSpeed "$GITHUB_WORKSPACE/lineage-os/ramdisk.cpio" ramdisk.cpio.lz4
          python3 $GITHUB_WORKSPACE/mkbootimg/mkbootimg.py \
            --kernel out/arch/arm64/boot/Image \
            --ramdisk ramdisk.cpio.lz4 \
            --dtb "$GITHUB_WORKSPACE/lineage-os/dtb" \
            --pagesize 4096 \
            --base 0x00000000 \
            --kernel_offset 0x00008000 \
            --ramdisk_offset 0x01000000 \
            --tags_offset 0x00000100 \
            --dtb_offset 0x01f00000 \
            --header_version 2 \
            --os_version 16.0.0 \
            --os_patch_level 2025-12 \
            --cmdline "androidboot.hardware=qcom androidboot.memcg=1 androidboot.usbcontroller=a600000.dwc3 cgroup.memory=nokmem,nosocket loop.max_part=7 lpm_levels.sleep_disabled=1 msm_rtb.filter=0x237 reboot=panic_warm service_locator.enable=1 swiotlb=2048" \
            --output "$GITHUB_WORKSPACE/$BOOT_IMG"
          echo "BOOT_IMG=$BOOT_IMG" >> $GITHUB_ENV
          ls -lh "$GITHUB_WORKSPACE/$BOOT_IMG"

      - name: Upload AnyKernel3 ZIP
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}

      - name: Upload boot.img
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BOOT_IMG }}
          path: ${{ env.BOOT_IMG }}

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: sukisu-debug-${{ github.run_number }}
          name: SukiSU-Ultra Debug (No SUSFS) Build ${{ github.run_number }}
          body: |
            ## SukiSU-Ultra Debug Build (NO SUSFS)

            This is a **debug build** to test if base SukiSU still boots:
            - Uses SukiSU-Ultra builtin setup
            - NO SUSFS patches
            - NO kernel backports (path_umount, get_cred_rcu)

            If this boots, the SUSFS patches/backports are causing the issue.
            If this doesn't boot, the base SukiSU setup has changed.
          files: |
            ${{ env.ZIP_NAME }}
            ${{ env.BOOT_IMG }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
