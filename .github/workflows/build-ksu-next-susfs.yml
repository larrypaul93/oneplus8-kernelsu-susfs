name: Build LOS23 Kernel with KernelSU + SUSFS (Non-GKI)

on:
  workflow_dispatch:

env:
  KERNEL_SOURCE: https://github.com/LineageOS/android_kernel_oneplus_sm8250.git
  KERNEL_BRANCH: lineage-23.0

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y git curl wget bc bison build-essential flex \
            libssl-dev libelf-dev python3 cpio zip android-sdk-libsparse-utils lz4

      - name: Setup mkbootimg tools
        run: |
          git clone --depth=1 https://android.googlesource.com/platform/system/tools/mkbootimg
          chmod +x mkbootimg/*.py
          echo "$GITHUB_WORKSPACE/mkbootimg" >> $GITHUB_PATH

      - name: Setup Clang
        run: |
          mkdir -p toolchains/clang
          curl -sL "https://github.com/ZyCromerZ/Clang/releases/download/14.0.6-20250704-release/Clang-14.0.6-20250704.tar.gz" | \
            tar -xzf - -C toolchains/clang
          echo "$GITHUB_WORKSPACE/toolchains/clang/bin" >> $GITHUB_PATH

      - name: Setup GCC
        run: |
          git clone --depth=1 -b android12L-release \
            https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 \
            toolchains/gcc64
          git clone --depth=1 -b android12L-release \
            https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9 \
            toolchains/gcc32
          echo "$GITHUB_WORKSPACE/toolchains/gcc64/bin" >> $GITHUB_PATH
          echo "$GITHUB_WORKSPACE/toolchains/gcc32/bin" >> $GITHUB_PATH

      - name: Clone Kernel
        run: |
          git clone --depth=1 -b $KERNEL_BRANCH $KERNEL_SOURCE kernel

      - name: Clone susfs4ksu for kernel 4.19
        run: |
          echo "Cloning susfs4ksu kernel-4.19 branch..."
          git clone --depth=1 -b kernel-4.19 https://gitlab.com/simonpunk/susfs4ksu.git susfs4ksu
          ls -la susfs4ksu/kernel_patches/

      - name: Fix LineageOS 23 Bugs
        run: |
          cd kernel
          sed -i 's/if (pon->log_kpd_event && (cfg->pon_type == PON_KPDPWR))/if (0)/' drivers/input/misc/qpnp-power-on.c
          sed -i 's/if (pon->log_kpd_event) {/if (0) {/' drivers/input/misc/qpnp-power-on.c
          sed -i '/pon->log_kpd_event = of_property_read_bool/,/"qcom,log-kpd-event");/d' drivers/input/misc/qpnp-power-on.c
          sed -i '1i struct smb_charger;' drivers/power/supply/qcom/schgm-flash.h || true
          sed -i '/#include "schgm-flash.h"/a #include "smb5-lib.h"' drivers/power/supply/qcom/schgm-flash.c || true
          sed -i 's/global_zone_page_state(NR_IONCACHE_PAGES)/0/g' drivers/staging/android/ion/ion_system_heap.c || true

      - name: Copy SUSFS kernel files
        run: |
          cd kernel
          echo "Copying SUSFS source files to kernel..."
          cp $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/fs/susfs.c fs/
          cp $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/include/linux/*.h include/linux/
          ls -la fs/susfs.c
          ls -la include/linux/susfs*.h

      - name: Apply SUSFS kernel patch
        run: |
          cd kernel
          echo "Applying SUSFS kernel hooks patch for kernel 4.19..."
          patch -p1 --no-backup-if-mismatch -F3 < $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/50_add_susfs_in_kernel-4.19.patch || echo "Some hunks failed - will fix manually"
          find . -name "*.rej" -delete 2>/dev/null || true
          find . -name "*.orig" -delete 2>/dev/null || true
          if ! grep -q "susfs.o" fs/Makefile; then
            echo "Adding susfs.o to fs/Makefile..."
            sed -i '/^obj-y.*:=/a obj-$(CONFIG_KSU_SUSFS) += susfs.o' fs/Makefile
          fi

      - name: Backport path_umount and get_cred_rcu
        run: |
          cd kernel
          echo "Adding kernel backports for 4.19..."

          if ! grep -q "^static int can_umount" fs/namespace.c; then
            echo "" >> fs/namespace.c
            echo "/* Backport can_umount for SUSFS/KernelSU */" >> fs/namespace.c
            echo "static int can_umount(const struct path *path, int flags)" >> fs/namespace.c
            echo "{" >> fs/namespace.c
            echo "    struct mount *mnt = real_mount(path->mnt);" >> fs/namespace.c
            echo "    if (flags & ~(MNT_FORCE | MNT_DETACH | MNT_EXPIRE | UMOUNT_NOFOLLOW))" >> fs/namespace.c
            echo "        return -EINVAL;" >> fs/namespace.c
            echo "    if (!may_mount())" >> fs/namespace.c
            echo "        return -EPERM;" >> fs/namespace.c
            echo "    if (path->dentry != path->mnt->mnt_root)" >> fs/namespace.c
            echo "        return -EINVAL;" >> fs/namespace.c
            echo "    if (!check_mnt(mnt))" >> fs/namespace.c
            echo "        return -EINVAL;" >> fs/namespace.c
            echo "    if (mnt->mnt.mnt_flags & MNT_LOCKED)" >> fs/namespace.c
            echo "        return -EINVAL;" >> fs/namespace.c
            echo "    if (flags & MNT_FORCE && !capable(CAP_SYS_ADMIN))" >> fs/namespace.c
            echo "        return -EPERM;" >> fs/namespace.c
            echo "    return 0;" >> fs/namespace.c
            echo "}" >> fs/namespace.c
          fi

          if ! grep -q "^int path_umount" fs/namespace.c; then
            echo "" >> fs/namespace.c
            echo "/* Backport path_umount from Linux 5.9+ for KernelSU/SUSFS */" >> fs/namespace.c
            echo "int path_umount(struct path *path, int flags)" >> fs/namespace.c
            echo "{" >> fs/namespace.c
            echo "    struct mount *mnt = real_mount(path->mnt);" >> fs/namespace.c
            echo "    int ret;" >> fs/namespace.c
            echo "    ret = can_umount(path, flags);" >> fs/namespace.c
            echo "    if (!ret)" >> fs/namespace.c
            echo "        ret = do_umount(mnt, flags);" >> fs/namespace.c
            echo "    dput(path->dentry);" >> fs/namespace.c
            echo "    mntput_no_expire(mnt);" >> fs/namespace.c
            echo "    return ret;" >> fs/namespace.c
            echo "}" >> fs/namespace.c
            echo "EXPORT_SYMBOL(path_umount);" >> fs/namespace.c
          fi

          if ! grep -q "int path_umount" fs/internal.h; then
            sed -i '/^extern void __init mnt_init/a int path_umount(struct path *path, int flags);' fs/internal.h
          fi

          if ! grep -q "get_cred_rcu" include/linux/cred.h; then
            echo "Adding get_cred_rcu backport..."
            echo "" > /tmp/get_cred_rcu.txt
            echo "/* Backport get_cred_rcu for KernelSU */" >> /tmp/get_cred_rcu.txt
            echo "static inline const struct cred *get_cred_rcu(const struct cred *cred)" >> /tmp/get_cred_rcu.txt
            echo "{" >> /tmp/get_cred_rcu.txt
            echo "    struct cred *nonconst_cred = (struct cred *) cred;" >> /tmp/get_cred_rcu.txt
            echo "    if (!cred)" >> /tmp/get_cred_rcu.txt
            echo "        return NULL;" >> /tmp/get_cred_rcu.txt
            echo "    if (!atomic_inc_not_zero(&nonconst_cred->usage))" >> /tmp/get_cred_rcu.txt
            echo "        return NULL;" >> /tmp/get_cred_rcu.txt
            echo "    return cred;" >> /tmp/get_cred_rcu.txt
            echo "}" >> /tmp/get_cred_rcu.txt
            echo "" >> /tmp/get_cred_rcu.txt
            LINE=$(grep -n "^static inline void put_cred" include/linux/cred.h | head -1 | cut -d: -f1)
            if [ -n "$LINE" ]; then
              head -n $((LINE - 1)) include/linux/cred.h > /tmp/cred_new.h
              cat /tmp/get_cred_rcu.txt >> /tmp/cred_new.h
              tail -n +$LINE include/linux/cred.h >> /tmp/cred_new.h
              mv /tmp/cred_new.h include/linux/cred.h
            fi
          fi

          echo 'CFLAGS_namespace.o += -Wno-unused-function' >> fs/Makefile

      - name: Setup KernelSU (original repo)
        run: |
          cd kernel
          echo "Setting up KernelSU (original repo - compatible with SUSFS patch)..."
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
          if [ ! -d "drivers/kernelsu" ]; then
            echo "ERROR: KernelSU setup failed!"
            exit 1
          fi
          ls -la drivers/kernelsu/
          echo "KernelSU version:"
          cat drivers/kernelsu/Makefile | head -20
          # Verify core_hook.c exists (required by SUSFS patch)
          ls -la drivers/kernelsu/../kernel/core_hook.c 2>/dev/null || ls -la $(readlink -f drivers/kernelsu)/core_hook.c 2>/dev/null || echo "Warning: core_hook.c not found"

      - name: Apply SUSFS patch to KernelSU
        run: |
          cd kernel
          echo "Applying SUSFS patch to KernelSU driver..."

          # Find where KernelSU was cloned (drivers/kernelsu is a symlink to KernelSU/kernel)
          KSU_DIR=$(readlink -f drivers/kernelsu)
          KSU_PARENT=$(dirname "$KSU_DIR")
          echo "KernelSU directory: $KSU_PARENT"
          ls -la "$KSU_PARENT"

          # Copy patch to KernelSU parent and apply from there
          cp $GITHUB_WORKSPACE/susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch "$KSU_PARENT/"
          cd "$KSU_PARENT"

          echo "Applying SUSFS patch with -p1 from KernelSU root..."
          # Use --dry-run first to see what would happen
          echo "=== Dry run first ==="
          patch -p1 -F3 --dry-run < 10_enable_susfs_for_ksu.patch 2>&1 || true
          echo "=== Applying patch ==="
          patch -p1 -F3 < 10_enable_susfs_for_ksu.patch 2>&1 || true

          # Check for rejected hunks
          if ls kernel/*.rej 2>/dev/null; then
            echo "=== REJECTED HUNKS ==="
            cat kernel/*.rej
            echo "=== Attempting manual fixes ==="
          fi

          rm -f 10_enable_susfs_for_ksu.patch
          find . -name "*.rej" -delete 2>/dev/null || true
          find . -name "*.orig" -delete 2>/dev/null || true

          echo "Verifying SUSFS integration in KernelSU..."
          grep -l "susfs" kernel/*.c kernel/*.h 2>/dev/null | head -10 || echo "Warning: No susfs references found"
          grep -q "KSU_SUSFS" kernel/Kconfig && echo "SUSFS Kconfig options added" || echo "Warning: SUSFS Kconfig not found"

      - name: Manually add SUSFS support if patch failed
        run: |
          cd kernel
          KSU_DIR=$(readlink -f drivers/kernelsu)

          # Check if SUSFS was properly integrated
          if ! grep -q "CONFIG_KSU_SUSFS" "$KSU_DIR/Kconfig"; then
            echo "SUSFS patch may have failed, adding manual integration..."

            # Add SUSFS include to core_hook.c if not present
            if ! grep -q "#include <linux/susfs.h>" "$KSU_DIR/core_hook.c"; then
              sed -i '/#include "throne_tracker.h"/a #ifdef CONFIG_KSU_SUSFS\n#include <linux\/susfs.h>\n#endif' "$KSU_DIR/core_hook.c"
            fi

            # Add basic SUSFS Kconfig if not present
            if ! grep -q "KSU_SUSFS" "$KSU_DIR/Kconfig"; then
              echo '' >> "$KSU_DIR/Kconfig"
              echo 'menu "KernelSU - SUSFS"' >> "$KSU_DIR/Kconfig"
              echo 'config KSU_SUSFS' >> "$KSU_DIR/Kconfig"
              echo '    bool "KernelSU addon - SUSFS"' >> "$KSU_DIR/Kconfig"
              echo '    depends on KSU' >> "$KSU_DIR/Kconfig"
              echo '    default y' >> "$KSU_DIR/Kconfig"
              echo '' >> "$KSU_DIR/Kconfig"
              echo 'config KSU_SUSFS_SUS_PATH' >> "$KSU_DIR/Kconfig"
              echo '    bool "Enable sus_path"' >> "$KSU_DIR/Kconfig"
              echo '    depends on KSU_SUSFS' >> "$KSU_DIR/Kconfig"
              echo '    default y' >> "$KSU_DIR/Kconfig"
              echo '' >> "$KSU_DIR/Kconfig"
              echo 'config KSU_SUSFS_SUS_MOUNT' >> "$KSU_DIR/Kconfig"
              echo '    bool "Enable sus_mount"' >> "$KSU_DIR/Kconfig"
              echo '    depends on KSU_SUSFS' >> "$KSU_DIR/Kconfig"
              echo '    default y' >> "$KSU_DIR/Kconfig"
              echo '' >> "$KSU_DIR/Kconfig"
              echo 'config KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT' >> "$KSU_DIR/Kconfig"
              echo '    bool "Auto add sus KSU default mount"' >> "$KSU_DIR/Kconfig"
              echo '    depends on KSU_SUSFS_SUS_MOUNT' >> "$KSU_DIR/Kconfig"
              echo '    default y' >> "$KSU_DIR/Kconfig"
              echo '' >> "$KSU_DIR/Kconfig"
              echo 'config KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT' >> "$KSU_DIR/Kconfig"
              echo '    bool "Auto add sus bind mount"' >> "$KSU_DIR/Kconfig"
              echo '    depends on KSU_SUSFS_SUS_MOUNT' >> "$KSU_DIR/Kconfig"
              echo '    default y' >> "$KSU_DIR/Kconfig"
              echo '' >> "$KSU_DIR/Kconfig"
              echo 'config KSU_SUSFS_SUS_KSTAT' >> "$KSU_DIR/Kconfig"
              echo '    bool "Enable sus_kstat"' >> "$KSU_DIR/Kconfig"
              echo '    depends on KSU_SUSFS' >> "$KSU_DIR/Kconfig"
              echo '    default y' >> "$KSU_DIR/Kconfig"
              echo '' >> "$KSU_DIR/Kconfig"
              echo 'config KSU_SUSFS_TRY_UMOUNT' >> "$KSU_DIR/Kconfig"
              echo '    bool "Enable try_umount"' >> "$KSU_DIR/Kconfig"
              echo '    depends on KSU_SUSFS' >> "$KSU_DIR/Kconfig"
              echo '    default y' >> "$KSU_DIR/Kconfig"
              echo '' >> "$KSU_DIR/Kconfig"
              echo 'config KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT' >> "$KSU_DIR/Kconfig"
              echo '    bool "Auto add try_umount for bind mount"' >> "$KSU_DIR/Kconfig"
              echo '    depends on KSU_SUSFS_TRY_UMOUNT' >> "$KSU_DIR/Kconfig"
              echo '    default y' >> "$KSU_DIR/Kconfig"
              echo '' >> "$KSU_DIR/Kconfig"
              echo 'config KSU_SUSFS_SPOOF_UNAME' >> "$KSU_DIR/Kconfig"
              echo '    bool "Enable spoof_uname"' >> "$KSU_DIR/Kconfig"
              echo '    depends on KSU_SUSFS' >> "$KSU_DIR/Kconfig"
              echo '    default y' >> "$KSU_DIR/Kconfig"
              echo '' >> "$KSU_DIR/Kconfig"
              echo 'config KSU_SUSFS_ENABLE_LOG' >> "$KSU_DIR/Kconfig"
              echo '    bool "Enable SUSFS logging"' >> "$KSU_DIR/Kconfig"
              echo '    depends on KSU_SUSFS' >> "$KSU_DIR/Kconfig"
              echo '    default y' >> "$KSU_DIR/Kconfig"
              echo '' >> "$KSU_DIR/Kconfig"
              echo 'config KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS' >> "$KSU_DIR/Kconfig"
              echo '    bool "Hide KSU SUSFS symbols"' >> "$KSU_DIR/Kconfig"
              echo '    depends on KSU_SUSFS' >> "$KSU_DIR/Kconfig"
              echo '    default y' >> "$KSU_DIR/Kconfig"
              echo '' >> "$KSU_DIR/Kconfig"
              echo 'config KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG' >> "$KSU_DIR/Kconfig"
              echo '    bool "Enable cmdline/bootconfig spoofing"' >> "$KSU_DIR/Kconfig"
              echo '    depends on KSU_SUSFS' >> "$KSU_DIR/Kconfig"
              echo '    default y' >> "$KSU_DIR/Kconfig"
              echo '' >> "$KSU_DIR/Kconfig"
              echo 'config KSU_SUSFS_OPEN_REDIRECT' >> "$KSU_DIR/Kconfig"
              echo '    bool "Enable open_redirect"' >> "$KSU_DIR/Kconfig"
              echo '    depends on KSU_SUSFS' >> "$KSU_DIR/Kconfig"
              echo '    default y' >> "$KSU_DIR/Kconfig"
              echo '' >> "$KSU_DIR/Kconfig"
              echo 'endmenu' >> "$KSU_DIR/Kconfig"
            fi
          fi

          # Verify final state
          echo "=== Final Kconfig check ==="
          grep -A5 "KSU_SUSFS" "$KSU_DIR/Kconfig" | head -20
          echo "=== Final core_hook.c check ==="
          grep -c "susfs" "$KSU_DIR/core_hook.c" || echo "0 susfs references"

      - name: Disable kprobes and enable manual hooks
        run: |
          cd kernel/drivers/kernelsu
          echo "Disabling kprobes to force manual hooks..."
          for f in *.c *.h; do
            if [ -f "$f" ]; then
              sed -i 's/#ifdef CONFIG_KPROBES/#if defined(CONFIG_KPROBES) \&\& 0/g' "$f"
              sed -i 's/#if defined(CONFIG_KPROBES)/#if defined(CONFIG_KPROBES) \&\& 0/g' "$f"
            fi
          done
          echo "ccflags-y += -DKSU_UMOUNT" >> Makefile

      - name: Add Manual KSU Hooks for Non-GKI
        run: |
          cd kernel
          echo "Adding manual KernelSU hooks for non-GKI kernel..."
          if [ -f "$GITHUB_WORKSPACE/scripts/add-ksu-hooks.sh" ]; then
            bash $GITHUB_WORKSPACE/scripts/add-ksu-hooks.sh
          else
            echo "Hook script not found!"
            exit 1
          fi

      - name: Use Device Config
        run: |
          cd kernel
          mkdir -p out
          cp $GITHUB_WORKSPACE/device_config out/.config
          make O=out ARCH=arm64 olddefconfig

      - name: Enable KSU and SUSFS in Config
        run: |
          cd kernel
          scripts/config --file out/.config -e KSU
          scripts/config --file out/.config -e KSU_SUSFS
          scripts/config --file out/.config -e KSU_SUSFS_SUS_PATH
          scripts/config --file out/.config -e KSU_SUSFS_SUS_MOUNT
          scripts/config --file out/.config -e KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT
          scripts/config --file out/.config -e KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT
          scripts/config --file out/.config -e KSU_SUSFS_SUS_KSTAT
          scripts/config --file out/.config -e KSU_SUSFS_TRY_UMOUNT
          scripts/config --file out/.config -e KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT
          scripts/config --file out/.config -e KSU_SUSFS_SPOOF_UNAME
          scripts/config --file out/.config -e KSU_SUSFS_ENABLE_LOG
          scripts/config --file out/.config -e KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS
          scripts/config --file out/.config -e KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG
          scripts/config --file out/.config -e KSU_SUSFS_OPEN_REDIRECT
          scripts/config --file out/.config -e KALLSYMS
          scripts/config --file out/.config -e KALLSYMS_ALL
          make O=out ARCH=arm64 olddefconfig
          grep -E "CONFIG_KSU" out/.config | head -30

      - name: Build Kernel
        run: |
          cd kernel
          make -j$(nproc --all) O=out ARCH=arm64 CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-android- \
            CROSS_COMPILE_ARM32=arm-linux-androideabi- \
            LLVM_IAS=1 LD=ld.lld AR=llvm-ar NM=llvm-nm \
            OBJCOPY=llvm-objcopy OBJDUMP=llvm-objdump STRIP=llvm-strip

      - name: Package
        run: |
          cd kernel
          if [ ! -f "out/arch/arm64/boot/Image" ]; then
            echo "Build failed!"
            exit 1
          fi
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git
          cd AnyKernel3
          rm -rf .git modules patch ramdisk
          cp ../out/arch/arm64/boot/Image .
          sed -i 's/do.devicecheck=.*/do.devicecheck=1/g' anykernel.sh
          sed -i 's/device.name1=.*/device.name1=instantnoodlep/g' anykernel.sh
          sed -i 's|block=.*|block=/dev/block/bootdevice/by-name/boot;|g' anykernel.sh
          sed -i 's/is_slot_device=.*/is_slot_device=1;/g' anykernel.sh
          ZIP_NAME="KSU-SUSFS_OnePlus8Pro_$(date +%Y%m%d).zip"
          zip -r9 "$GITHUB_WORKSPACE/$ZIP_NAME" * -x .git README.md *placeholder
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Create boot.img
        run: |
          cd kernel
          BOOT_IMG="KSU-SUSFS_boot_OnePlus8Pro_$(date +%Y%m%d).img"
          lz4 -l -12 --favor-decSpeed "$GITHUB_WORKSPACE/lineage-os/ramdisk.cpio" ramdisk.cpio.lz4
          python3 $GITHUB_WORKSPACE/mkbootimg/mkbootimg.py \
            --kernel out/arch/arm64/boot/Image \
            --ramdisk ramdisk.cpio.lz4 \
            --dtb "$GITHUB_WORKSPACE/lineage-os/dtb" \
            --pagesize 4096 \
            --base 0x00000000 \
            --kernel_offset 0x00008000 \
            --ramdisk_offset 0x01000000 \
            --tags_offset 0x00000100 \
            --dtb_offset 0x01f00000 \
            --header_version 2 \
            --os_version 16.0.0 \
            --os_patch_level 2025-12 \
            --cmdline "androidboot.hardware=qcom androidboot.memcg=1 androidboot.usbcontroller=a600000.dwc3 cgroup.memory=nokmem,nosocket loop.max_part=7 lpm_levels.sleep_disabled=1 msm_rtb.filter=0x237 reboot=panic_warm service_locator.enable=1 swiotlb=2048" \
            --output "$GITHUB_WORKSPACE/$BOOT_IMG"
          echo "BOOT_IMG=$BOOT_IMG" >> $GITHUB_ENV
          ls -lh "$GITHUB_WORKSPACE/$BOOT_IMG"

      - name: Upload AnyKernel3 ZIP
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}

      - name: Upload boot.img
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BOOT_IMG }}
          path: ${{ env.BOOT_IMG }}

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ksu-susfs-${{ github.run_number }}
          name: KernelSU + SUSFS Build ${{ github.run_number }}
          body: |
            ## KernelSU + SUSFS for OnePlus 8 Pro (LineageOS 23)

            This build uses:
            - [KernelSU](https://github.com/tiann/KernelSU) (original repo for SUSFS compatibility)
            - [susfs4ksu](https://gitlab.com/simonpunk/susfs4ksu) kernel-4.19 branch
            - Manual syscall hooks (kprobes disabled)

            ### SUSFS Features
            - SUS_PATH, SUS_MOUNT, SUS_KSTAT
            - SPOOF_UNAME, OPEN_REDIRECT
            - HIDE_KSU_SUSFS_SYMBOLS, TRY_UMOUNT

            ### Installation
            - Flash via TWRP or fastboot boot.img

            ### Manager
            Use KernelSU Manager from: https://github.com/tiann/KernelSU/releases
          files: |
            ${{ env.ZIP_NAME }}
            ${{ env.BOOT_IMG }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
