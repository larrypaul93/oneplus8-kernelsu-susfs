name: Build OnePlus 8 Kernel with KernelSU-Next + SUSFS

on:
  workflow_dispatch:
    inputs:
      kernelsu_variant:
        description: 'KernelSU variant'
        required: true
        default: 'sukisu'
        type: choice
        options:
          - sukisu
          - next
          - rsuntk
      susfs_enabled:
        description: 'Enable SUSFS'
        required: true
        default: true
        type: boolean
      device_name:
        description: 'Device name for zip'
        required: true
        default: 'OnePlus8_Series'

env:
  # Official OnePlus kernel source for OOS 13.1
  KERNEL_SOURCE: https://github.com/OnePlusOSS/android_kernel_oneplus_sm8250.git
  KERNEL_BRANCH: oneplus/sm8250_t_13.1_op8
  DEFCONFIG: vendor/kona-perf_defconfig
  DEVICE_NAME: ${{ github.event.inputs.device_name || 'OnePlus8_Series' }}
  KERNELSU_VARIANT: ${{ github.event.inputs.kernelsu_variant || 'sukisu' }}
  SUSFS_ENABLED: ${{ github.event.inputs.susfs_enabled || 'true' }}
  # Patches repo
  PATCHES_REPO: JackA1ltman/NonGKI_Kernel_Patches
  PATCHES_BRANCH: op_kernel

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: false
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git curl wget bc bison build-essential ccache flex \
            g++-multilib gcc-multilib gnupg gperf imagemagick \
            lib32ncurses-dev lib32z1-dev \
            liblz4-tool libncurses-dev libssl-dev \
            libxml2 libxml2-utils lzop pngcrush rsync schedtool \
            squashfs-tools xsltproc zip zlib1g-dev python3 python3-pip \
            cpio kmod libelf-dev device-tree-compiler jq

      - name: Setup Clang Toolchain
        run: |
          mkdir -p $GITHUB_WORKSPACE/toolchains/clang
          curl -sL "https://github.com/ZyCromerZ/Clang/releases/download/15.0.7-20251111-release/Clang-15.0.7-20251111.tar.gz" | \
            tar -xzf - -C $GITHUB_WORKSPACE/toolchains/clang
          echo "$GITHUB_WORKSPACE/toolchains/clang/bin" >> $GITHUB_PATH

      - name: Setup GCC Toolchains
        run: |
          git clone --depth=1 -b android12L-release \
            https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 \
            $GITHUB_WORKSPACE/toolchains/gcc64
          git clone --depth=1 -b android12L-release \
            https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9 \
            $GITHUB_WORKSPACE/toolchains/gcc32
          echo "$GITHUB_WORKSPACE/toolchains/gcc64/bin" >> $GITHUB_PATH
          echo "$GITHUB_WORKSPACE/toolchains/gcc32/bin" >> $GITHUB_PATH

      - name: Clone Kernel Source
        run: |
          git clone --depth=1 -b $KERNEL_BRANCH $KERNEL_SOURCE kernel

      - name: Clone Patches Repo
        run: |
          git clone --depth=1 -b $PATCHES_BRANCH https://github.com/$PATCHES_REPO.git patches

      - name: Setup KernelSU
        run: |
          cd kernel

          case "$KERNELSU_VARIANT" in
            sukisu)
              echo "Setting up SukiSU-Ultra..."
              curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main
              ;;
            next)
              echo "Setting up KernelSU-Next..."
              curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/stable/kernel/setup.sh" | bash -s stable
              ;;
            rsuntk)
              echo "Setting up rsuntk KernelSU..."
              curl -LSs "https://raw.githubusercontent.com/rsuntk/KernelSU/main/kernel/setup.sh" | bash -s main
              ;;
          esac

      - name: Apply SUSFS Patches
        if: env.SUSFS_ENABLED == 'true'
        run: |
          cd kernel

          # Find KernelSU directory
          KSU_DIR=$(find . -maxdepth 1 -type d -name "KernelSU*" | head -1)
          echo "KernelSU directory: $KSU_DIR"

          # Clone susfs4ksu for kernel patches
          echo "Cloning susfs4ksu..."
          git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b kernel-4.19 susfs4ksu || \
          git clone --depth=1 https://github.com/sidex15/susfs4ksu.git -b kernel-4.19 susfs4ksu || true

          # Apply SUSFS patch to KernelSU
          echo "Applying SUSFS patch to KernelSU..."
          if [ -n "$KSU_DIR" ] && [ -d "$KSU_DIR" ]; then
            # Try universal patch first
            if [ -f "../patches/KernelSU-Next-Implement-SUSFS-v1.5.5-Universal.patch" ]; then
              cd "$KSU_DIR"
              git apply "../../patches/KernelSU-Next-Implement-SUSFS-v1.5.5-Universal.patch" || echo "Universal patch may already be applied or needs adjustment"
              cd ..
            fi

            # Try susfs4ksu KernelSU patches
            if [ -d "susfs4ksu/kernel_patches/KernelSU" ]; then
              echo "Applying susfs4ksu KernelSU patches..."
              cd "$KSU_DIR"
              for patch in ../susfs4ksu/kernel_patches/KernelSU/*.patch; do
                if [ -f "$patch" ]; then
                  echo "Applying $(basename $patch)..."
                  git apply "$patch" || echo "Patch $(basename $patch) may already be applied"
                fi
              done
              cd ..
            fi
          fi

          # Copy SUSFS source files to kernel
          if [ -d "susfs4ksu/kernel_patches" ]; then
            echo "Copying SUSFS kernel files..."
            cp -v susfs4ksu/kernel_patches/fs/susfs.c fs/ 2>/dev/null || true
            cp -v susfs4ksu/kernel_patches/fs/sus_su.c fs/ 2>/dev/null || true
            cp -v susfs4ksu/kernel_patches/include/linux/susfs.h include/linux/ 2>/dev/null || true
            cp -v susfs4ksu/kernel_patches/include/linux/susfs_def.h include/linux/ 2>/dev/null || true
            cp -v susfs4ksu/kernel_patches/include/linux/sus_su.h include/linux/ 2>/dev/null || true

            # Add susfs to fs/Makefile if not present
            if ! grep -q "susfs.o" fs/Makefile; then
              echo 'obj-$(CONFIG_KSU_SUSFS) += susfs.o' >> fs/Makefile
              echo 'obj-$(CONFIG_KSU_SUSFS_SUS_SU) += sus_su.o' >> fs/Makefile
            fi
          fi

          # Apply main kernel SUSFS patch
          echo "Applying kernel SUSFS patch..."
          if [ -f "susfs4ksu/kernel_patches/50_add_susfs_in_kernel-4.19.patch" ]; then
            git apply susfs4ksu/kernel_patches/50_add_susfs_in_kernel-4.19.patch || echo "Kernel SUSFS patch may need manual adjustment"
          fi

          # Apply device-specific SUSFS fixes
          if [ -f "../patches/kona_cos15_a15/susfs_fixed.patch" ]; then
            echo "Applying device-specific SUSFS fixes..."
            git apply "../patches/kona_cos15_a15/susfs_fixed.patch" || echo "Device patch may already be applied"
          fi

      - name: Apply VFS Hook Patches
        run: |
          cd kernel
          if [ -f "../patches/vfs_hook_patches.sh" ]; then
            echo "Applying VFS hook patches..."
            bash ../patches/vfs_hook_patches.sh || echo "VFS patches may already be applied"
          fi

      - name: Configure Kernel
        run: |
          cd kernel

          export ARCH=arm64
          export SUBARCH=arm64

          make O=out ARCH=arm64 CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-android- \
            CROSS_COMPILE_ARM32=arm-linux-androideabi- \
            $DEFCONFIG

          # Enable KernelSU
          scripts/config --file out/.config -e KSU

          # Enable SUSFS if enabled
          if [ "$SUSFS_ENABLED" = "true" ]; then
            scripts/config --file out/.config -e KSU_SUSFS || true
            scripts/config --file out/.config -e KSU_SUSFS_SUS_PATH || true
            scripts/config --file out/.config -e KSU_SUSFS_SUS_MOUNT || true
            scripts/config --file out/.config -e KSU_SUSFS_SUS_KSTAT || true
            scripts/config --file out/.config -e KSU_SUSFS_TRY_UMOUNT || true
            scripts/config --file out/.config -e KSU_SUSFS_SPOOF_UNAME || true
            scripts/config --file out/.config -e KSU_SUSFS_ENABLE_LOG || true
            scripts/config --file out/.config -e KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS || true
          fi

          # Regenerate config
          make O=out ARCH=arm64 olddefconfig

      - name: Build Kernel
        run: |
          cd kernel

          make -j$(nproc --all) O=out ARCH=arm64 CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-android- \
            CROSS_COMPILE_ARM32=arm-linux-androideabi- \
            NM=llvm-nm \
            OBJDUMP=llvm-objdump \
            STRIP=llvm-strip \
            2>&1 | tee build.log

      - name: Check Build Result
        run: |
          cd kernel
          if [ ! -f "out/arch/arm64/boot/Image" ]; then
            echo "======== BUILD FAILED ========"
            echo "Last 200 lines of build log:"
            tail -200 build.log
            exit 1
          fi
          echo "Kernel built successfully!"
          ls -la out/arch/arm64/boot/

      - name: Package with AnyKernel3
        run: |
          cd kernel
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git
          cd AnyKernel3
          rm -rf .git modules patch ramdisk
          cp ../out/arch/arm64/boot/Image .
          [ -f "../out/arch/arm64/boot/dtb" ] && cp ../out/arch/arm64/boot/dtb .
          [ -f "../out/arch/arm64/boot/dtbo.img" ] && cp ../out/arch/arm64/boot/dtbo.img .
          sed -i "s/do.devicecheck=.*/do.devicecheck=1/g" anykernel.sh
          sed -i "s/do.modules=.*/do.modules=0/g" anykernel.sh
          sed -i "s/device.name1=.*/device.name1=instantnoodle/g" anykernel.sh
          sed -i "s/device.name2=.*/device.name2=instantnoodlep/g" anykernel.sh
          sed -i "s|block=.*|block=/dev/block/bootdevice/by-name/boot;|g" anykernel.sh
          sed -i "s/is_slot_device=.*/is_slot_device=1;/g" anykernel.sh
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          SUSFS_TAG=""
          [ "$SUSFS_ENABLED" = "true" ] && SUSFS_TAG="_SUSFS"
          ZIP_NAME="KernelSU-${KERNELSU_VARIANT}${SUSFS_TAG}_${DEVICE_NAME}_${TIMESTAMP}.zip"
          zip -r9 "$GITHUB_WORKSPACE/$ZIP_NAME" * -x .git README.md *placeholder
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: KernelSU Build ${{ github.run_number }}
          body: |
            ## OnePlus 8 Series Kernel Build

            **Kernel Source:** ${{ env.KERNEL_SOURCE }}
            **Branch:** ${{ env.KERNEL_BRANCH }}
            **KernelSU Variant:** ${{ env.KERNELSU_VARIANT }}
            **SUSFS:** ${{ env.SUSFS_ENABLED }}

            ### Supported Devices
            - OnePlus 8 (instantnoodle)
            - OnePlus 8 Pro (instantnoodlep)
            - OnePlus 8T (kebab)
            - OnePlus 9R (lemonades)

            ### Installation
            1. Boot to TWRP/custom recovery
            2. Flash the zip file
            3. Reboot

            Or use fastboot:
            ```
            fastboot flash boot boot.img
            ```
          files: ${{ env.ZIP_NAME }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
