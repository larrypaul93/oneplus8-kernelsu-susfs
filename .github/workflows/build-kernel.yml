name: Build OnePlus 8 Kernel with KernelSU-Next + SUSFS

on:
  workflow_dispatch:
    inputs:
      kernelsu_variant:
        description: 'KernelSU variant'
        required: true
        default: 'ksu'
        type: choice
        options:
          - ksu
          - sukisu
          - next
          - rsuntk
      susfs_enabled:
        description: 'Enable SUSFS'
        required: true
        default: true
        type: boolean
      device_name:
        description: 'Device name for zip'
        required: true
        default: 'OnePlus8_Series'

env:
  # JackA1ltman's prepared kernel source (clean, no KSU)
  KERNEL_SOURCE: https://github.com/JackA1ltman/android_kernel_oneplus_sm8250_los_noksu.git
  KERNEL_BRANCH: staging
  DEFCONFIG: vendor/kona-perf_defconfig
  DEVICE_NAME: ${{ github.event.inputs.device_name || 'OnePlus8_Series' }}
  KERNELSU_VARIANT: ${{ github.event.inputs.kernelsu_variant || 'ksu' }}
  SUSFS_ENABLED: ${{ github.event.inputs.susfs_enabled || 'true' }}
  # Patches repo
  PATCHES_REPO: JackA1ltman/NonGKI_Kernel_Patches
  PATCHES_BRANCH: op_kernel

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: false
          dotnet: true
          haskell: true
          large-packages: true
          swap-storage: true

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git curl wget bc bison build-essential ccache flex \
            g++-multilib gcc-multilib gnupg gperf imagemagick \
            lib32ncurses-dev lib32z1-dev \
            liblz4-tool libncurses-dev libssl-dev \
            libxml2 libxml2-utils lzop pngcrush rsync schedtool \
            squashfs-tools xsltproc zip zlib1g-dev python3 python3-pip \
            cpio kmod libelf-dev device-tree-compiler jq

      - name: Setup Clang Toolchain
        run: |
          mkdir -p $GITHUB_WORKSPACE/toolchains/clang
          # Using Clang 14 for better kernel 4.19 compatibility
          curl -sL "https://github.com/ZyCromerZ/Clang/releases/download/14.0.6-20250704-release/Clang-14.0.6-20250704.tar.gz" | \
            tar -xzf - -C $GITHUB_WORKSPACE/toolchains/clang
          echo "$GITHUB_WORKSPACE/toolchains/clang/bin" >> $GITHUB_PATH

      - name: Setup GCC Toolchains
        run: |
          git clone --depth=1 -b android12L-release \
            https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9 \
            $GITHUB_WORKSPACE/toolchains/gcc64
          git clone --depth=1 -b android12L-release \
            https://android.googlesource.com/platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9 \
            $GITHUB_WORKSPACE/toolchains/gcc32
          echo "$GITHUB_WORKSPACE/toolchains/gcc64/bin" >> $GITHUB_PATH
          echo "$GITHUB_WORKSPACE/toolchains/gcc32/bin" >> $GITHUB_PATH

      - name: Clone Kernel Source
        run: |
          git clone --depth=1 -b $KERNEL_BRANCH $KERNEL_SOURCE kernel

      - name: Fix vDSO Compilation for Clang
        run: |
          cd kernel
          # Fix vDSO compilation error with Clang + GNU assembler
          # The issue is Clang generates DWARF debug info (.file directives) that GNU as doesn't understand
          # Solution: Disable debug info generation for vDSO with -g0
          VDSO_MAKEFILE="arch/arm64/kernel/vdso/Makefile"
          if [ -f "$VDSO_MAKEFILE" ]; then
            echo "Patching vDSO Makefile for Clang compatibility..."
            # Disable debug info generation which causes .file directive issues
            if ! grep -q -- "-g0" "$VDSO_MAKEFILE"; then
              echo 'ccflags-y += -g0' >> "$VDSO_MAKEFILE"
            fi
            echo "vDSO Makefile after patching:"
            cat "$VDSO_MAKEFILE"
          fi

          # Also patch vdso32 if it exists
          VDSO32_MAKEFILE="arch/arm64/kernel/vdso32/Makefile"
          if [ -f "$VDSO32_MAKEFILE" ]; then
            echo "Patching vDSO32 Makefile..."
            if ! grep -q -- "-g0" "$VDSO32_MAKEFILE"; then
              echo 'ccflags-y += -g0' >> "$VDSO32_MAKEFILE"
            fi
          fi

      - name: Clone Patches Repo
        run: |
          git clone --depth=1 -b $PATCHES_BRANCH https://github.com/$PATCHES_REPO.git patches

      - name: Setup KernelSU
        run: |
          cd kernel

          case "$KERNELSU_VARIANT" in
            ksu)
              echo "Setting up original KernelSU (tiann)..."
              curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
              ;;
            sukisu)
              echo "Setting up SukiSU-Ultra..."
              curl -LSs "https://raw.githubusercontent.com/ShirkNeko/SukiSU-Ultra/main/kernel/setup.sh" | bash -s main
              ;;
            next)
              echo "Setting up KernelSU-Next (legacy)..."
              curl -LSs "https://raw.githubusercontent.com/KernelSU-Next/KernelSU-Next/legacy/kernel/setup.sh" | bash -s legacy
              ;;
            rsuntk)
              echo "Setting up rsuntk KernelSU..."
              curl -LSs "https://raw.githubusercontent.com/rsuntk/KernelSU/main/kernel/setup.sh" | bash -s main
              ;;
          esac

      - name: Fix KernelSU for Kernel 4.19 Compatibility
        run: |
          cd kernel

          KSU_DIR=$(find . -maxdepth 1 -type d -name "KernelSU*" | head -1)
          echo "KernelSU directory: $KSU_DIR"

          # Create compatibility header for kernel 4.19 (handles multiple missing APIs)
          COMPAT_HEADER="include/linux/ksu_compat.h"
          printf '/* KernelSU compatibility header for kernel 4.19 */\n' > "$COMPAT_HEADER"
          printf '#ifndef _LINUX_KSU_COMPAT_H\n' >> "$COMPAT_HEADER"
          printf '#define _LINUX_KSU_COMPAT_H\n\n' >> "$COMPAT_HEADER"
          printf '#include <linux/sched/task.h>\n' >> "$COMPAT_HEADER"
          printf '#include <linux/task_work.h>\n\n' >> "$COMPAT_HEADER"
          printf '/* MODULE_IMPORT_NS was introduced in kernel 5.4 */\n' >> "$COMPAT_HEADER"
          printf '#ifndef MODULE_IMPORT_NS\n' >> "$COMPAT_HEADER"
          printf '#define MODULE_IMPORT_NS(ns)\n' >> "$COMPAT_HEADER"
          printf '#endif\n\n' >> "$COMPAT_HEADER"
          printf '/* TWA_RESUME was introduced in kernel 5.7 */\n' >> "$COMPAT_HEADER"
          printf '/* In 4.19, task_work_add takes bool notify, use true for same effect */\n' >> "$COMPAT_HEADER"
          printf '#ifndef TWA_RESUME\n' >> "$COMPAT_HEADER"
          printf '#define TWA_RESUME true\n' >> "$COMPAT_HEADER"
          printf '#endif\n\n' >> "$COMPAT_HEADER"
          printf '#endif /* _LINUX_KSU_COMPAT_H */\n' >> "$COMPAT_HEADER"
          echo "Created compatibility header: $COMPAT_HEADER"
          cat "$COMPAT_HEADER"

          # Add compat header to all KernelSU source files that need kernel 4.19 fixes
          if [ -n "$KSU_DIR" ] && [ -d "$KSU_DIR" ]; then
            echo "Adding compatibility header to KernelSU source files..."
            for ksu_file in $(find "$KSU_DIR/kernel" -name "*.c" 2>/dev/null); do
              # Check if file uses any API that needs compat fixes
              if grep -qE "MODULE_IMPORT_NS|TWA_RESUME|put_task_struct|task_work_add" "$ksu_file"; then
                echo "Patching $ksu_file..."
                if ! grep -q "ksu_compat.h" "$ksu_file"; then
                  sed -i '1i #include <linux/ksu_compat.h>' "$ksu_file"
                fi
              fi
            done
          fi

          if [ -d "drivers/kernelsu" ]; then
            echo "Adding compatibility header to drivers/kernelsu..."
            for ksu_file in drivers/kernelsu/*.c; do
              if [ -f "$ksu_file" ]; then
                if grep -qE "MODULE_IMPORT_NS|TWA_RESUME|put_task_struct|task_work_add" "$ksu_file"; then
                  echo "Patching $ksu_file..."
                  if ! grep -q "ksu_compat.h" "$ksu_file"; then
                    sed -i '1i #include <linux/ksu_compat.h>' "$ksu_file"
                  fi
                fi
              fi
            done
          fi

          if grep -q "ksu_handle_execveat" fs/exec.c 2>/dev/null; then
            echo "Found KernelSU hooks in fs/exec.c"
            if ! grep -q "ksu.h" fs/exec.c; then
              echo "Adding KernelSU include..."
              sed -i '/#include <linux\/fs.h>/a #include <linux/ksu.h>' fs/exec.c || true
            fi
          fi

      - name: Apply SUSFS Patches
        if: env.SUSFS_ENABLED == 'true'
        run: |
          cd kernel

          # Find KernelSU directory
          KSU_DIR=$(find . -maxdepth 1 -type d -name "KernelSU*" | head -1)
          echo "KernelSU directory: $KSU_DIR"

          # Clone susfs4ksu for kernel patches (kernel-4.19 branch)
          echo "Cloning susfs4ksu (kernel-4.19 branch)..."
          git clone --depth=1 https://gitlab.com/simonpunk/susfs4ksu.git -b kernel-4.19 susfs4ksu || \
          git clone --depth=1 https://github.com/sidex15/susfs4ksu.git -b kernel-4.19 susfs4ksu

          # Step 1: Apply revert commit in KernelSU (as per official instructions)
          echo "Step 1: Reverting kprobe commit in KernelSU..."
          if [ -n "$KSU_DIR" ] && [ -d "$KSU_DIR" ]; then
            cd "$KSU_DIR"
            git revert --no-commit 898e9d4f8ca9b2f46b0c6b36b80a872b5b88d899 2>/dev/null || echo "Revert may not be needed for this version"
            cd ..
          fi

          # Step 2: Disable kprobes in KernelSU (replace #ifdef CONFIG_KPROBES with #if defined(CONFIG_KPROBES) && 0)
          echo "Step 2: Disabling kprobes in KernelSU..."
          if [ -n "$KSU_DIR" ] && [ -d "$KSU_DIR" ]; then
            find "$KSU_DIR" -name "*.c" -o -name "*.h" | xargs sed -i 's/#ifdef CONFIG_KPROBES/#if defined(CONFIG_KPROBES) \&\& 0/g' 2>/dev/null || true
            find "$KSU_DIR" -name "*.c" -o -name "*.h" | xargs sed -i 's/#if defined(CONFIG_KPROBES)/#if defined(CONFIG_KPROBES) \&\& 0/g' 2>/dev/null || true
          fi

          # Step 3: Copy SUSFS patch to KernelSU folder and apply
          echo "Step 3: Copying and applying SUSFS KernelSU patch..."
          if [ -f "susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch" ]; then
            cp susfs4ksu/kernel_patches/KernelSU/10_enable_susfs_for_ksu.patch "$KSU_DIR/"
            cd "$KSU_DIR"
            patch -p1 < 10_enable_susfs_for_ksu.patch || echo "KernelSU SUSFS patch may need adjustment"
            cd ..
          fi

          # Step 4: Copy SUSFS source files to kernel
          echo "Step 4: Copying SUSFS source files..."
          cp -v susfs4ksu/kernel_patches/fs/* fs/ 2>/dev/null || true
          cp -v susfs4ksu/kernel_patches/include/linux/* include/linux/ 2>/dev/null || true

          # Step 5: Copy and apply kernel SUSFS patch
          echo "Step 5: Applying kernel SUSFS patch..."
          cp susfs4ksu/kernel_patches/50_add_susfs_in_kernel-4.19.patch ./
          patch -p1 < 50_add_susfs_in_kernel-4.19.patch || echo "Kernel SUSFS patch may need manual adjustment"

          # Step 6: Apply device-specific fixes if available
          if [ -f "../patches/kona_cos15_a15/susfs_fixed.patch" ]; then
            echo "Step 6: Applying device-specific SUSFS fixes..."
            patch -p1 < ../patches/kona_cos15_a15/susfs_fixed.patch || echo "Device patch may already be applied"
          fi

      - name: Apply VFS Hook Patches
        run: |
          cd kernel
          if [ -f "../patches/vfs_hook_patches.sh" ]; then
            echo "Applying VFS hook patches..."
            bash ../patches/vfs_hook_patches.sh || echo "VFS patches may already be applied"
          fi

      - name: Configure Kernel
        run: |
          cd kernel

          export ARCH=arm64
          export SUBARCH=arm64

          make O=out ARCH=arm64 CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-android- \
            CROSS_COMPILE_ARM32=arm-linux-androideabi- \
            $DEFCONFIG

          # Enable KernelSU
          scripts/config --file out/.config -e KSU

          # Enable SUSFS if enabled
          if [ "$SUSFS_ENABLED" = "true" ]; then
            scripts/config --file out/.config -e KSU_SUSFS || true
            scripts/config --file out/.config -e KSU_SUSFS_SUS_PATH || true
            scripts/config --file out/.config -e KSU_SUSFS_SUS_MOUNT || true
            scripts/config --file out/.config -e KSU_SUSFS_SUS_KSTAT || true
            scripts/config --file out/.config -e KSU_SUSFS_TRY_UMOUNT || true
            scripts/config --file out/.config -e KSU_SUSFS_SPOOF_UNAME || true
            scripts/config --file out/.config -e KSU_SUSFS_ENABLE_LOG || true
            scripts/config --file out/.config -e KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS || true
          fi

          # Regenerate config
          make O=out ARCH=arm64 olddefconfig

      - name: Build Kernel
        run: |
          cd kernel

          # Use LLVM_IAS=1 to use Clang's integrated assembler
          # This properly handles DWARF debug info that GNU as doesn't understand
          make -j$(nproc --all) O=out ARCH=arm64 CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-android- \
            CROSS_COMPILE_ARM32=arm-linux-androideabi- \
            LLVM_IAS=1 \
            LD=ld.lld \
            AR=llvm-ar \
            NM=llvm-nm \
            OBJCOPY=llvm-objcopy \
            OBJDUMP=llvm-objdump \
            STRIP=llvm-strip \
            2>&1 | tee build.log

      - name: Check Build Result
        run: |
          cd kernel
          if [ ! -f "out/arch/arm64/boot/Image" ]; then
            echo "======== BUILD FAILED ========"
            echo "Last 200 lines of build log:"
            tail -200 build.log
            exit 1
          fi
          echo "Kernel built successfully!"
          ls -la out/arch/arm64/boot/

      - name: Package with AnyKernel3
        run: |
          cd kernel
          git clone --depth=1 https://github.com/osm0sis/AnyKernel3.git
          cd AnyKernel3
          rm -rf .git modules patch ramdisk
          cp ../out/arch/arm64/boot/Image .
          [ -f "../out/arch/arm64/boot/dtb" ] && cp ../out/arch/arm64/boot/dtb .
          [ -f "../out/arch/arm64/boot/dtbo.img" ] && cp ../out/arch/arm64/boot/dtbo.img .
          sed -i "s/do.devicecheck=.*/do.devicecheck=1/g" anykernel.sh
          sed -i "s/do.modules=.*/do.modules=0/g" anykernel.sh
          sed -i "s/device.name1=.*/device.name1=instantnoodle/g" anykernel.sh
          sed -i "s/device.name2=.*/device.name2=instantnoodlep/g" anykernel.sh
          sed -i "s|block=.*|block=/dev/block/bootdevice/by-name/boot;|g" anykernel.sh
          sed -i "s/is_slot_device=.*/is_slot_device=1;/g" anykernel.sh
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          SUSFS_TAG=""
          [ "$SUSFS_ENABLED" = "true" ] && SUSFS_TAG="_SUSFS"
          ZIP_NAME="KernelSU-${KERNELSU_VARIANT}${SUSFS_TAG}_${DEVICE_NAME}_${TIMESTAMP}.zip"
          zip -r9 "$GITHUB_WORKSPACE/$ZIP_NAME" * -x .git README.md *placeholder
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: build-${{ github.run_number }}
          name: KernelSU Build ${{ github.run_number }}
          body: |
            ## OnePlus 8 Series Kernel Build

            **Kernel Source:** ${{ env.KERNEL_SOURCE }}
            **Branch:** ${{ env.KERNEL_BRANCH }}
            **KernelSU Variant:** ${{ env.KERNELSU_VARIANT }}
            **SUSFS:** ${{ env.SUSFS_ENABLED }}

            ### Supported Devices
            - OnePlus 8 (instantnoodle)
            - OnePlus 8 Pro (instantnoodlep)
            - OnePlus 8T (kebab)
            - OnePlus 9R (lemonades)

            ### Installation
            1. Boot to TWRP/custom recovery
            2. Flash the zip file
            3. Reboot

            Or use fastboot:
            ```
            fastboot flash boot boot.img
            ```
          files: ${{ env.ZIP_NAME }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
